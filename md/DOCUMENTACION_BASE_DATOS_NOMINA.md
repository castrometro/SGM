# üìã Documentaci√≥n Completa de Base de Datos - M√≥dulo N√≥mina

## üéØ Introducci√≥n

Este documento presenta la arquitectura completa de la base de datos del m√≥dulo de n√≥mina del SGM (Sistema de Gesti√≥n de Microempresas). El m√≥dulo maneja el procesamiento de n√≥minas con un enfoque de consolidaci√≥n de m√∫ltiples fuentes de datos y manejo colaborativo de incidencias.

## üèóÔ∏è Arquitectura General

La base de datos est√° estructurada en **6 niveles principales**:

1. **üîÑ Gesti√≥n de Cierres** - Control del proceso de cierre mensual
2. **üìÑ Archivos y Cargas** - Gesti√≥n de archivos subidos y su procesamiento  
3. **üë• Empleados y Conceptos** - Datos de empleados y conceptos de remuneraci√≥n
4. **üìä Movimientos de Personal** - Altas, bajas, ausencias y variaciones
5. **üö® Incidencias y Discrepancias** - Sistema colaborativo de resoluci√≥n
6. **üíº Consolidaci√≥n Final** - Datos procesados y listos para reportes

---

## 1Ô∏è‚É£ GESTI√ìN DE CIERRES

### üîÑ CierreNomina
**Prop√≥sito**: Entidad central que controla el proceso completo del cierre mensual de n√≥mina.

**Atributos Principales**:
- `cliente`: Referencia al cliente (empresa)
- `periodo`: Mes/a√±o del cierre (YYYY-MM)
- `estado`: Estado del proceso de cierre
- `estado_consolidacion`: Control de consolidaci√≥n de datos
- `estado_incidencias`: Control del manejo de incidencias
- `clasificaciones_archivos`: JSON con mapeo de archivos
- `configuracion_tolerancias`: JSON con tolerancias para an√°lisis

**Estados del Cierre**:
- `pendiente` ‚Üí `cargando_archivos` ‚Üí `archivos_completos` ‚Üí `clasificaciones_completas` ‚Üí `consolidado` ‚Üí `completado`

**M√©todos Importantes**:
- `actualizar_estado_automatico()`: Actualiza estado seg√∫n archivos procesados
- `puede_generar_incidencias()`: Verifica si est√° listo para an√°lisis
- `_verificar_archivos_listos()`: Valida que archivos obligatorios est√©n procesados

### ‚úÖ ChecklistItem  
**Prop√≥sito**: Elementos de verificaci√≥n manual del cierre.

**Atributos**:
- `cierre`: Referencia al cierre
- `descripcion`: Descripci√≥n del item a verificar
- `estado`: `pendiente` | `completado` | `no_realizado`
- `comentario`: Observaciones del analista

---

## 2Ô∏è‚É£ ARCHIVOS Y CARGAS

### üìä LibroRemuneracionesUpload
**Prop√≥sito**: Archivo principal con datos de remuneraciones del per√≠odo.

**Atributos**:
- `archivo`: Archivo Excel/CSV subido
- `estado`: Control del procesamiento
- `header_json`: Headers detectados en el archivo
- `upload_log`: Referencia al log del upload

**Estados**: `pendiente` ‚Üí `analizando_hdrs` ‚Üí `hdrs_analizados` ‚Üí `clasif_en_proceso` ‚Üí `clasif_pendiente` ‚Üí `clasificado`

### üîÑ MovimientosMesUpload
**Prop√≥sito**: Archivo con movimientos de personal (altas, bajas, ausencias).

**Atributos**:
- `archivo`: Archivo con movimientos
- `estado`: Estado de procesamiento
- `resultados_procesamiento`: JSON con resultados del an√°lisis

**Estados**: `pendiente` ‚Üí `en_proceso` ‚Üí `procesado` | `con_error` | `con_errores_parciales`

### üëî ArchivoAnalistaUpload
**Prop√≥sito**: Archivos espec√≠ficos subidos por analistas (ingresos, finiquitos, incidencias).

**Atributos**:
- `tipo_archivo`: `ingresos` | `finiquitos` | `incidencias`
- `archivo`: Archivo subido
- `analista`: Usuario que subi√≥ el archivo
- `estado`: Control de procesamiento

### üìù ArchivoNovedadesUpload
**Prop√≥sito**: Archivo opcional con novedades/variaciones del per√≠odo.

**Atributos**:
- `archivo`: Archivo de novedades
- `header_json`: Headers detectados
- `estado`: Similar a libro de remuneraciones

### üìã UploadLogNomina (impl√≠cito)
**Prop√≥sito**: Log de todos los uploads realizados (referenciado en otros modelos).

---

## 3Ô∏è‚É£ EMPLEADOS Y CONCEPTOS

### üë• EmpleadoCierre
**Prop√≥sito**: Empleado espec√≠fico de un cierre con datos b√°sicos.

**Atributos**:
- `cierre`: Referencia al cierre
- `rut`: RUT del empleado
- `nombre`, `apellido_paterno`, `apellido_materno`: Datos personales
- `rut_empresa`: RUT de la empresa empleadora
- `dias_trabajados`: D√≠as trabajados en el per√≠odo

**Restricciones**: √önico por cierre y RUT.

### üë§ EmpleadoCierreNovedades
**Prop√≥sito**: Empleado espec√≠fico para procesamiento de novedades (separado del principal).

**Atributos**: Similar a EmpleadoCierre pero sin d√≠as trabajados.

### üí∞ ConceptoRemuneracion
**Prop√≥sito**: Conceptos de remuneraci√≥n clasificados por cliente.

**Atributos**:
- `cliente`: Cliente propietario
- `nombre_concepto`: Nombre del concepto
- `clasificacion`: Tipo de concepto (haber, descuento, etc.)
- `hashtags`: JSON con etiquetas de clasificaci√≥n
- `usuario_clasifica`: Quien clasific√≥ el concepto
- `vigente`: Si est√° activo

**Clasificaciones Disponibles**:
- Haberes imponibles/no imponibles
- Descuentos legales/otros
- Aportes patronales
- Solo informativos

### üíµ RegistroConceptoEmpleado
**Prop√≥sito**: Registros individuales de conceptos por empleado del libro de remuneraciones.

**Atributos**:
- `empleado`: Referencia al empleado
- `concepto`: Concepto clasificado (puede ser null)
- `nombre_concepto_original`: Nombre tal como aparece en archivo
- `monto`: Valor del concepto (string, puede contener texto)

**Propiedades Calculadas**:
- `monto_numerico`: Convierte monto a n√∫mero
- `es_numerico`: Verifica si es convertible

### üîó ConceptoRemuneracionNovedades
**Prop√≥sito**: Mapeo entre headers de novedades y conceptos del libro principal.

**Atributos**:
- `nombre_concepto_novedades`: Header en archivo de novedades
- `concepto_libro`: Mapeo al concepto principal
- `usuario_mapea`: Usuario que cre√≥ el mapeo
- `activo`: Estado del mapeo

### üìä RegistroConceptoEmpleadoNovedades
**Prop√≥sito**: Registros de conceptos para empleados desde archivo de novedades.

**Atributos**: Similar a RegistroConceptoEmpleado pero con referencia a novedades.

---

## 4Ô∏è‚É£ MOVIMIENTOS DE PERSONAL

### ‚¨ÜÔ∏è MovimientoAltaBaja
**Prop√≥sito**: Registros de ingresos y retiros de empleados.

**Atributos**:
- Datos completos del empleado
- `fecha_ingreso`, `fecha_retiro`: Fechas del movimiento
- `alta_o_baja`: Tipo de movimiento
- `motivo`: Raz√≥n del movimiento
- `sueldo_base`: Sueldo base del empleado

### üè• MovimientoAusentismo
**Prop√≥sito**: Registros de ausencias (licencias m√©dicas, permisos, etc.).

**Atributos**:
- `fecha_inicio_ausencia`, `fecha_fin_ausencia`: Per√≠odo de ausencia
- `dias`: Cantidad de d√≠as
- `tipo`: Tipo de ausentismo
- `motivo`, `observaciones`: Detalles adicionales

### üèñÔ∏è MovimientoVacaciones
**Prop√≥sito**: Registros espec√≠ficos de vacaciones.

**Atributos**:
- `fecha_inicio`, `fecha_fin_vacaciones`, `fecha_retorno`: Fechas del per√≠odo
- `cantidad_dias`: D√≠as de vacaciones

### üí∏ MovimientoVariacionSueldo
**Prop√≥sito**: Cambios en el sueldo base de empleados.

**Atributos**:
- `sueldo_base_anterior`, `sueldo_base_actual`: Valores antes/despu√©s
- `porcentaje_reajuste`: Porcentaje de cambio
- `variacion_pesos`: Diferencia en pesos

### üìã MovimientoVariacionContrato
**Prop√≥sito**: Cambios en tipo de contrato de empleados.

**Atributos**:
- `tipo_contrato_anterior`, `tipo_contrato_actual`: Tipos antes/despu√©s

### üëî AnalistaFiniquito, AnalistaIncidencia, AnalistaIngreso
**Prop√≥sito**: Datos espec√≠ficos subidos por analistas para validaci√≥n.

**Atributos Comunes**:
- `archivo_origen`: Referencia al archivo que los gener√≥
- `rut`, `nombre`: Datos del empleado
- Campos espec√≠ficos seg√∫n el tipo de movimiento

---

## 5Ô∏è‚É£ INCIDENCIAS Y DISCREPANCIAS

### üö® IncidenciaCierre
**Prop√≥sito**: Incidencias detectadas que requieren resoluci√≥n colaborativa entre analista y supervisor.

**Atributos Principales**:
- `tipo_incidencia`: Tipo de problema detectado
- `descripcion`: Descripci√≥n detallada
- `valor_libro`, `valor_novedades`, `valor_movimientos`, `valor_analista`: Valores de cada fuente
- `estado`: Estado de resoluci√≥n
- `prioridad`: Nivel de importancia
- `impacto_monetario`: Impacto econ√≥mico calculado
- `asignado_a`: Usuario responsable de resolver

**Tipos de Incidencias**:
- `variacion_concepto`: Variaciones >30% en conceptos
- `concepto_nuevo`: Conceptos que aparecen por primera vez
- `concepto_perdido`: Conceptos que desaparecen
- `empleado_deberia_ingresar`: Empleados esperados pero no presentes
- `empleado_no_deberia_estar`: Empleados presentes pero no esperados
- `ausentismo_continuo`: Ausencias prolongadas

**Estados de Resoluci√≥n**:
- `pendiente` ‚Üí `resuelta_analista` ‚Üí `aprobada_supervisor` | `rechazada_supervisor`

### üí¨ ResolucionIncidencia
**Prop√≥sito**: Historial de conversaciones y resoluciones de incidencias.

**Atributos**:
- `tipo_resolucion`: Tipo de acci√≥n tomada
- `comentario`: Explicaci√≥n/justificaci√≥n
- `adjunto`: Archivo de soporte
- `valor_corregido`: Valor corregido si aplica
- `usuarios_mencionados`: Usuarios mencionados en la resoluci√≥n

### üîç DiscrepanciaCierre
**Prop√≥sito**: Sistema informativo de verificaci√≥n de datos (no requiere resoluci√≥n obligatoria).

**Atributos**:
- `tipo_discrepancia`: Tipo de diferencia encontrada
- Valores comparados entre fuentes
- Solo registra diferencias para conocimiento

**Tipos de Discrepancias**:
- Diferencias Libro vs Novedades
- Diferencias MovimientosMes vs Analista
- Datos faltantes o inconsistentes

---

## 6Ô∏è‚É£ AN√ÅLISIS Y CONSOLIDACI√ìN

### üìä AnalisisDatosCierre
**Prop√≥sito**: An√°lisis estad√≠stico comparativo con el per√≠odo anterior.

**Atributos**:
- Contadores actuales vs anteriores (empleados, ingresos, finiquitos, ausentismos)
- `ausentismos_por_tipo_actual`, `ausentismos_por_tipo_anterior`: JSON con estad√≠sticas
- `tolerancia_variacion_salarial`: Configuraci√≥n de tolerancias
- `estado`: Estado del an√°lisis

**M√©todos**:
- `calcular_variaciones()`: Calcula variaciones porcentuales
- `_calcular_variacion_porcentual()`: C√°lculo individual

### üìà IncidenciaVariacionSalarial
**Prop√≥sito**: Incidencias espec√≠ficas de cambios salariales significativos.

**Atributos**:
- Datos salariales comparativos
- `porcentaje_variacion`: Porcentaje de cambio
- `tipo_variacion`: `aumento` | `disminucion`
- Sistema completo de justificaci√≥n y aprobaci√≥n

**Flujo de Resoluci√≥n**:
1. Detecci√≥n autom√°tica
2. Asignaci√≥n a analista
3. Justificaci√≥n del analista
4. Revisi√≥n del supervisor
5. Aprobaci√≥n/rechazo final

---

## 7Ô∏è‚É£ CONSOLIDACI√ìN FINAL

### üíº NominaConsolidada
**Prop√≥sito**: **REGISTRO FINAL** - Un empleado por cierre con toda su informaci√≥n consolidada y totales finales.

**Atributos Principales**:
- `rut_empleado`, `nombre_empleado`: Identificaci√≥n
- `cargo`, `centro_costo`: Ubicaci√≥n organizacional
- `estado_empleado`: Estado del empleado en este per√≠odo
- `total_haberes`, `total_descuentos`, `liquido_pagar`: **TOTALES FINALES**
- `dias_trabajados`, `dias_ausencia`: Informaci√≥n de asistencia
- `fuente_datos`: JSON con fuentes usadas para consolidar

**Estados de Empleado**:
- `activo`: Empleado normal
- `nueva_incorporacion`: Ingreso nuevo
- `finiquito`: Empleado retirado
- `ausente_total`: Sin asistencia en el per√≠odo
- `ausente_parcial`: Ausencias parciales

### üí∞ ConceptoConsolidado
**Prop√≥sito**: Conceptos individuales por empleado con clasificaci√≥n y totales finales.

**Atributos**:
- `codigo_concepto`, `nombre_concepto`: Identificaci√≥n
- `tipo_concepto`: Clasificaci√≥n final del concepto
- `monto_total`: **MONTO FINAL CONSOLIDADO**
- `cantidad`: Cantidad/horas si aplica
- `fuente_archivo`: Archivo origen del dato

**Tipos de Concepto**:
- `haber_imponible`, `haber_no_imponible`
- `descuento_legal`, `otro_descuento`
- `aporte_patronal`, `informativo`

### üîÑ MovimientoPersonal
**Prop√≥sito**: Resumen de movimientos detectados autom√°ticamente por empleado.

**Atributos**:
- `tipo_movimiento`: Tipo de cambio detectado
- `motivo`: Raz√≥n del movimiento
- `dias_ausencia`: D√≠as si es ausencia
- `fecha_movimiento`: Fecha del cambio
- `detectado_por_sistema`: Sistema que lo detect√≥

---

## üîó RELACIONES PRINCIPALES

### Flujo de Datos:
```
CierreNomina
‚îú‚îÄ‚îÄ Archivos Upload (4 tipos)
‚îÇ   ‚îú‚îÄ‚îÄ LibroRemuneracionesUpload ‚Üí EmpleadoCierre + RegistroConceptoEmpleado
‚îÇ   ‚îú‚îÄ‚îÄ MovimientosMesUpload ‚Üí MovimientoAltaBaja/Ausentismo/Vacaciones/etc.
‚îÇ   ‚îú‚îÄ‚îÄ ArchivoAnalistaUpload ‚Üí AnalistaFiniquito/Incidencia/Ingreso
‚îÇ   ‚îî‚îÄ‚îÄ ArchivoNovedadesUpload ‚Üí EmpleadoCierreNovedades + RegistroConceptoEmpleadoNovedades
‚îÇ
‚îú‚îÄ‚îÄ An√°lisis y Detecci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ AnalisisDatosCierre ‚Üí IncidenciaVariacionSalarial
‚îÇ   ‚îú‚îÄ‚îÄ DiscrepanciaCierre (verificaciones)
‚îÇ   ‚îî‚îÄ‚îÄ IncidenciaCierre ‚Üí ResolucionIncidencia
‚îÇ
‚îî‚îÄ‚îÄ Consolidaci√≥n Final
    ‚îú‚îÄ‚îÄ NominaConsolidada (RESULTADO FINAL)
    ‚îú‚îÄ‚îÄ ConceptoConsolidado (por empleado)
    ‚îî‚îÄ‚îÄ MovimientoPersonal (cambios detectados)
```

### Integraciones:
- **Cliente**: Todas las entidades se relacionan con el cliente
- **User**: Usuarios involucrados en clasificaci√≥n y resoluci√≥n
- **UploadLogNomina**: Trazabilidad de archivos

---

## üìã CASOS DE USO PRINCIPALES

1. **Subida y Procesamiento de Archivos**
   - Upload ‚Üí An√°lisis de headers ‚Üí Clasificaci√≥n ‚Üí Procesamiento ‚Üí Consolidaci√≥n

2. **Detecci√≥n de Incidencias**
   - Comparaci√≥n autom√°tica ‚Üí Generaci√≥n de incidencias ‚Üí Asignaci√≥n ‚Üí Resoluci√≥n colaborativa

3. **Verificaci√≥n de Datos**
   - Generaci√≥n de discrepancias informativas ‚Üí Revisi√≥n por analista

4. **Consolidaci√≥n Final**
   - Datos de m√∫ltiples fuentes ‚Üí NominaConsolidada ‚Üí Reportes y liquidaciones

5. **An√°lisis Comparativo**
   - Comparaci√≥n con per√≠odo anterior ‚Üí Detecci√≥n de variaciones ‚Üí Gesti√≥n de cambios significativos

---

## üéØ CONCLUSI√ìN

La base de datos del m√≥dulo n√≥mina implementa un **sistema completo de consolidaci√≥n de datos** que:

- ‚úÖ **Procesa m√∫ltiples fuentes** (libro, movimientos, analista, novedades)
- ‚úÖ **Detecta autom√°ticamente** inconsistencias e incidencias
- ‚úÖ **Facilita resoluci√≥n colaborativa** entre analistas y supervisores  
- ‚úÖ **Consolida datos finales** listos para reportes
- ‚úÖ **Mantiene trazabilidad completa** del proceso
- ‚úÖ **Permite an√°lisis estad√≠sticos** comparativos

El dise√±o permite manejar la complejidad inherente del procesamiento de n√≥minas manteniendo la integridad de datos y facilitando la detecci√≥n temprana de problemas.
