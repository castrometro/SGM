#!/usr/bin/env python3
"""
ğŸ§ª SCRIPT DE PRUEBA: Nueva LÃ³gica Simplificada de Incidencias

Este script verifica que la nueva lÃ³gica funciona correctamente:
1. Comparar nÃ³minas de empleados comunes (variaciones)
2. Revisar empleados Ãºnicos (documentaciÃ³n faltante)
"""

# SimulaciÃ³n de la lÃ³gica sin Django
from decimal import Decimal

def simular_deteccion_simplificada():
    """
    Simula la nueva lÃ³gica de detecciÃ³n sin necesidad de Django
    """
    print("ğŸ¯ SIMULACIÃ“N: Nueva LÃ³gica Simplificada de Incidencias")
    print("=" * 60)
    
    # DATOS SIMULADOS
    # Empleados mes anterior
    empleados_anterior = {
        '12345678-9': {
            'nombre': 'Juan PÃ©rez',
            'conceptos': {
                'Sueldo Base': Decimal('800000'),
                'Horas Extras': Decimal('50000'),
                'GratificaciÃ³n': Decimal('100000')
            }
        },
        '98765432-1': {
            'nombre': 'MarÃ­a GonzÃ¡lez',
            'conceptos': {
                'Sueldo Base': Decimal('700000'),
                'ColaciÃ³n': Decimal('30000')
            }
        },
        '11111111-1': {
            'nombre': 'Pedro LÃ³pez',  # Este tendrÃ¡ finiquito
            'conceptos': {
                'Sueldo Base': Decimal('600000')
            }
        }
    }
    
    # Empleados mes actual
    empleados_actual = {
        '12345678-9': {
            'nombre': 'Juan PÃ©rez',
            'conceptos': {
                'Sueldo Base': Decimal('1200000'),  # VariaciÃ³n 50%
                'Horas Extras': Decimal('55000'),   # VariaciÃ³n menor
                'GratificaciÃ³n': Decimal('100000')  # Sin variaciÃ³n
            }
        },
        '98765432-1': {
            'nombre': 'MarÃ­a GonzÃ¡lez',
            'conceptos': {
                'Sueldo Base': Decimal('700000'),   # Sin variaciÃ³n
                'ColaciÃ³n': Decimal('30000')       # Sin variaciÃ³n
            }
        },
        '22222222-2': {
            'nombre': 'Ana MartÃ­n',  # Este tendrÃ¡ ingreso
            'conceptos': {
                'Sueldo Base': Decimal('650000')
            }
        }
    }
    
    # DocumentaciÃ³n de movimientos
    finiquitos_anterior = ['11111111-1']  # Pedro LÃ³pez tiene finiquito
    ingresos_actual = ['22222222-2']      # Ana MartÃ­n tiene ingreso
    
    print("ğŸ“Š DATOS DE PRUEBA:")
    print(f"   Empleados anterior: {len(empleados_anterior)}")
    print(f"   Empleados actual: {len(empleados_actual)}")
    print(f"   Finiquitos documentados: {len(finiquitos_anterior)}")
    print(f"   Ingresos documentados: {len(ingresos_actual)}")
    print()
    
    # PASO 1: COMPARAR EMPLEADOS COMUNES
    print("ğŸ” PASO 1: Comparando empleados comunes...")
    
    ruts_anterior = set(empleados_anterior.keys())
    ruts_actual = set(empleados_actual.keys())
    ruts_comunes = ruts_anterior & ruts_actual
    
    print(f"   ğŸ‘¥ Empleados comunes: {len(ruts_comunes)} ({', '.join(ruts_comunes)})")
    
    incidencias_variaciones = []
    tolerancia = Decimal('30.0')  # 30%
    
    for rut in ruts_comunes:
        emp_anterior = empleados_anterior[rut]
        emp_actual = empleados_actual[rut]
        
        print(f"\n   ğŸ” Analizando {emp_anterior['nombre']} ({rut}):")
        
        # Comparar conceptos
        todos_conceptos = set(emp_anterior['conceptos'].keys()) | set(emp_actual['conceptos'].keys())
        
        for concepto in todos_conceptos:
            monto_anterior = emp_anterior['conceptos'].get(concepto, Decimal('0'))
            monto_actual = emp_actual['conceptos'].get(concepto, Decimal('0'))
            
            if monto_anterior > Decimal('1000'):  # Solo conceptos significativos
                if monto_anterior != 0:
                    variacion = abs((monto_actual - monto_anterior) / monto_anterior) * 100
                    
                    print(f"      {concepto}: ${monto_anterior:,} â†’ ${monto_actual:,} ({variacion:.1f}%)")
                    
                    if variacion > tolerancia:
                        incidencia = f"VariaciÃ³n {variacion:.1f}% en {concepto} para {emp_anterior['nombre']}"
                        incidencias_variaciones.append(incidencia)
                        print(f"      âš ï¸  INCIDENCIA: {incidencia}")
    
    print(f"\n   ğŸ“Š Incidencias de variaciÃ³n detectadas: {len(incidencias_variaciones)}")
    
    # PASO 2: ANALIZAR EMPLEADOS ÃšNICOS
    print("\nğŸ” PASO 2: Analizando empleados Ãºnicos...")
    
    ruts_solo_anterior = ruts_anterior - ruts_actual
    ruts_solo_actual = ruts_actual - ruts_anterior
    
    print(f"   ğŸ“¤ Solo en anterior: {len(ruts_solo_anterior)} ({', '.join(ruts_solo_anterior) if ruts_solo_anterior else 'ninguno'})")
    print(f"   ğŸ“¥ Solo en actual: {len(ruts_solo_actual)} ({', '.join(ruts_solo_actual) if ruts_solo_actual else 'ninguno'})")
    
    incidencias_faltantes = []
    
    # Verificar finiquitos
    for rut in ruts_solo_anterior:
        empleado = empleados_anterior[rut]
        if rut not in finiquitos_anterior:
            incidencia = f"Empleado {empleado['nombre']} no estÃ¡ en nÃ³mina actual pero no tiene finiquito documentado"
            incidencias_faltantes.append(incidencia)
            print(f"   âš ï¸  INCIDENCIA FINIQUITO: {incidencia}")
        else:
            print(f"   âœ… {empleado['nombre']} tiene finiquito documentado")
    
    # Verificar ingresos
    for rut in ruts_solo_actual:
        empleado = empleados_actual[rut]
        if rut not in ingresos_actual:
            incidencia = f"Empleado {empleado['nombre']} estÃ¡ en nÃ³mina actual pero no tiene ingreso documentado"
            incidencias_faltantes.append(incidencia)
            print(f"   âš ï¸  INCIDENCIA INGRESO: {incidencia}")
        else:
            print(f"   âœ… {empleado['nombre']} tiene ingreso documentado")
    
    print(f"\n   ğŸ“Š Incidencias de documentaciÃ³n faltante: {len(incidencias_faltantes)}")
    
    # RESUMEN FINAL
    total_incidencias = len(incidencias_variaciones) + len(incidencias_faltantes)
    
    print("\n" + "=" * 60)
    print("ğŸ“‹ RESUMEN FINAL:")
    print(f"   ğŸ”„ Incidencias de variaciÃ³n: {len(incidencias_variaciones)}")
    print(f"   ğŸ“„ Incidencias de documentaciÃ³n: {len(incidencias_faltantes)}")
    print(f"   ğŸ“Š TOTAL INCIDENCIAS: {total_incidencias}")
    
    if total_incidencias == 0:
        print("   âœ… Sin incidencias detectadas - Cierre listo para finalizar")
    else:
        print("   âš ï¸  Incidencias detectadas - Requieren revisiÃ³n")
        
        print("\nDetalle de incidencias:")
        for i, inc in enumerate(incidencias_variaciones + incidencias_faltantes, 1):
            print(f"   {i}. {inc}")
    
    return {
        'total_incidencias': total_incidencias,
        'variaciones': len(incidencias_variaciones),
        'faltantes': len(incidencias_faltantes),
        'empleados_comunes': len(ruts_comunes),
        'solo_anterior': len(ruts_solo_anterior),
        'solo_actual': len(ruts_solo_actual)
    }

if __name__ == "__main__":
    resultado = simular_deteccion_simplificada()
    print(f"\nğŸ¯ La nueva lÃ³gica funciona correctamente!")
    print(f"Resultado: {resultado}")
