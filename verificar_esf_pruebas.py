#!/usr/bin/env python3
"""
Script para verificar que el ESF se estÃ¡ guardando en carpeta de pruebas
====================================================================

Ejecutar despuÃ©s de una finalizaciÃ³n para ver si el ESF se guardÃ³ automÃ¡ticamente.
"""

import os
import sys
import django

# Configurar Django
sys.path.append('/root/SGM/backend')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')
django.setup()

from contabilidad.cache_redis import get_cache_system

def verificar_esf_en_pruebas():
    """Verificar si hay ESF en la carpeta de pruebas"""
    
    print("ğŸ” VERIFICANDO ESF EN CARPETA DE PRUEBAS")
    print("=" * 50)
    
    cache_system = get_cache_system()
    
    # Cliente y perÃ­odo de ejemplo
    cliente_id = 1
    periodo = "2025-07"
    
    print(f"Buscando ESF de prueba para Cliente {cliente_id}, PerÃ­odo {periodo}...")
    
    # Buscar ESF de finalizaciÃ³n automÃ¡tica
    esf_auto = cache_system.get_prueba_esf(cliente_id, periodo, "finalizacion_automatica")
    
    if esf_auto:
        print(f"âœ… ESF de finalizaciÃ³n automÃ¡tica encontrado!")
        print(f"   Source: {esf_auto.get('source', 'N/A')}")
        print(f"   Generated by: {esf_auto.get('generated_by', 'N/A')}")
        print(f"   Generated at: {esf_auto.get('generated_at', 'N/A')}")
        print(f"   Total Activos: ${esf_auto.get('total_activos', 0):,.2f}")
        print(f"   Total Pasivos: ${esf_auto.get('liabilities', {}).get('total_liabilities', 0):,.2f}")
        print(f"   Total Patrimonio: ${esf_auto.get('patrimony', {}).get('total_patrimony', 0):,.2f}")
        print(f"   Balance Cuadrado: {'âœ… SÃ' if esf_auto.get('balance_cuadrado', False) else 'âŒ NO'}")
        
        # Mostrar metadata
        metadata = esf_auto.get('metadata_prueba', {})
        if metadata:
            print(f"   ğŸ“Š Metadata:")
            print(f"      Cuentas procesadas: {metadata.get('total_cuentas_procesadas', 0)}")
            print(f"      VersiÃ³n sistema: {metadata.get('version_sistema', 'N/A')}")
            print(f"      Diferencia balance: ${metadata.get('diferencia_balance', 0):,.2f}")
    else:
        print(f"âŒ No se encontrÃ³ ESF de finalizaciÃ³n automÃ¡tica")
        print(f"   Esto puede significar que:")
        print(f"   1. No se ha ejecutado una finalizaciÃ³n reciente")
        print(f"   2. Hubo un error en el guardado")
        print(f"   3. Los datos estÃ¡n en otro cliente/perÃ­odo")
    
    # Listar todas las pruebas disponibles
    print(f"\nğŸ“‹ TODAS LAS PRUEBAS DISPONIBLES:")
    print("-" * 50)
    
    pruebas = cache_system.list_pruebas_cliente(cliente_id, periodo)
    
    if pruebas:
        for i, prueba in enumerate(pruebas, 1):
            print(f"{i}. Tipo: {prueba['data_type']}")
            print(f"   Test: {prueba['test_type']}")
            print(f"   Cliente: {prueba['cliente_id']}")
            print(f"   PerÃ­odo: {prueba['periodo']}")
            print(f"   Key: {prueba['redis_key']}")
            print(f"   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
    else:
        print(f"âŒ No hay pruebas disponibles para Cliente {cliente_id}, PerÃ­odo {periodo}")
    
    # EstadÃ­sticas generales
    print(f"\nğŸ“ˆ ESTADÃSTICAS DE CACHE:")
    print("-" * 50)
    
    stats = cache_system.get_cache_stats()
    print(f"Pruebas guardadas: {stats.get('pruebas_cached', 0)}")
    print(f"Pruebas recuperadas: {stats.get('pruebas_retrieved', 0)}")
    print(f"ESF de prueba guardados: {stats.get('pruebas_esf_cached', 0)}")
    print(f"Total claves de prueba: {stats.get('pruebas_keys', 0)}")

if __name__ == "__main__":
    try:
        verificar_esf_en_pruebas()
    except Exception as e:
        print(f"âŒ Error: {e}")
        import traceback
        traceback.print_exc()
