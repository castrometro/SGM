â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ”§ FIX: Movimientos del Mes - StubInstance Error                  â•‘
â•‘                ValueError al intentar asignar StubInstance                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… FECHA: 2025-10-17 15:42
ğŸ¯ OBJETIVO: Eliminar referencias al StubInstance en views_movimientos_mes.py

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROBLEMA: ValueError con StubInstance                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸš¨ ERROR:
   ValueError: Cannot assign "<nomina.models_logging_stub.StubInstance object>": 
   "MovimientosMesUpload.upload_log" must be a "UploadLogNomina" instance.

ğŸ“‹ CAUSA:
   El cÃ³digo intentaba asignar un StubInstance del sistema de logging stub
   al campo ForeignKey upload_log, pero Django requiere:
   - Una instancia real de UploadLogNomina
   - O None (null=True)
   
   Django NO acepta objetos stub/mock en campos ForeignKey.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SOLUCIÃ“N: Asignar None en lugar de StubInstance                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Archivo: backend/nomina/views_movimientos_mes.py
MÃ©todo: subir()

CAMBIOS REALIZADOS:

1. âœ… Deshabilitar creaciÃ³n de upload_log stub (lÃ­nea ~138-152)
   ANTES:
     mixin = UploadLogNominaMixin()
     upload_log = mixin.crear_upload_log(cliente, archivo)
     upload_log.cierre = cierre
     upload_log.save()
   
   DESPUÃ‰S:
     # STUB DESHABILITADO
     logger.debug(f"[STUB] UploadLog NO creado")

2. âœ… Asignar None a upload_log en UPDATE (lÃ­nea ~161)
   ANTES:
     movimiento_existente.upload_log = upload_log
   
   DESPUÃ‰S:
     movimiento_existente.upload_log = None  # STUB: No asignar

3. âœ… Asignar None a upload_log en CREATE (lÃ­nea ~170)
   ANTES:
     MovimientosMesUpload.objects.create(
         ...
         upload_log=upload_log
     )
   
   DESPUÃ‰S:
     MovimientosMesUpload.objects.create(
         ...
         upload_log=None  # STUB: No asignar
     )

4. âœ… Deshabilitar registro de actividad stub (lÃ­nea ~175-184)
   ANTES:
     registrar_actividad_tarjeta_nomina(
         cierre_id=cierre.id,
         ...
         upload_log=upload_log
     )
   
   DESPUÃ‰S:
     # STUB DESHABILITADO
     logger.debug(f"[STUB] Actividad NO registrada")

5. âœ… Deshabilitar actualizaciÃ³n de resumen (lÃ­nea ~182-184)
   ANTES:
     upload_log.resumen = {...}
     upload_log.save()
   
   DESPUÃ‰S:
     # STUB DESHABILITADO
     logger.debug(f"[STUB] Resumen NO guardado")

6. âœ… Pasar None a Celery task (lÃ­nea ~188)
   ANTES:
     procesar_movimientos_mes.delay(instance.id, upload_log.id)
   
   DESPUÃ‰S:
     procesar_movimientos_mes.delay(instance.id, None)

7. âœ… Eliminar todas las llamadas a upload_log.* (lÃ­neas ~191-199)
   ANTES:
     upload_log.celery_task_id = task.id
     upload_log.save()
     upload_log.resumen["celery_task_id"] = task.id
   
   DESPUÃ‰S:
     # CÃ³digo eliminado

8. âœ… Eliminar upload_log de respuesta (lÃ­nea ~215)
   ANTES:
     response_data['upload_log_id'] = upload_log.id
   
   DESPUÃ‰S:
     # LÃ­nea eliminada

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PATRÃ“N DE MIGRACIÃ“N: Logging Stub â†’ None                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Durante transiciÃ³n a ActivityEvent V2:

âŒ NO HACER:
   upload_log = mixin.crear_upload_log(...)  # Retorna StubInstance
   model.upload_log = upload_log              # ValueError!

âœ… HACER:
   model.upload_log = None                    # VÃ¡lido (si field permite null=True)

âœ… FUTURO (con ActivityEvent V2):
   ActivityEvent.log(
       user=request.user,
       cliente=cliente,
       event_type='upload',
       action='movimientos_mes_upload',
       resource_type='movimientos_mes',
       resource_id=str(instance.id),
       details={...},
       request=request
   )

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MODELO MOVIMIENTOSMESUPLOAD                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

class MovimientosMesUpload(models.Model):
    cierre = ForeignKey(CierreNomina, ...)
    archivo = FileField(upload_to='movimientos/')
    estado = CharField(max_length=50)
    upload_log = ForeignKey(
        UploadLogNomina, 
        null=True,        # âœ… Permite None
        blank=True,
        on_delete=SET_NULL
    )

VALIDACIÃ“N:
  âœ… Campo upload_log permite null=True
  âœ… Asignar None es vÃ¡lido
  âœ… No causa IntegrityError

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLUJO CORREGIDO                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usuario sube archivo de Movimientos del Mes:
  1. âœ… POST /api/nomina/movimientos/subir/30/
  2. âœ… Validar archivo y cierre
  3. âœ… Crear/actualizar MovimientosMesUpload con upload_log=None
  4. âœ… Iniciar task Celery: procesar_movimientos_mes.delay(id, None)
  5. âœ… Respuesta 201 Created con datos del modelo
  6. âœ… Celery procesa en background

SIN ERRORES:
  âœ… No hay ValueError de StubInstance
  âœ… Modelo se guarda correctamente en BD
  âœ… Task Celery inicia correctamente
  âœ… Frontend recibe respuesta exitosa

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMPACTO EN OTROS MÃ“DULOS                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MISMO PROBLEMA EN:
  âš ï¸  views_archivos_analista.py (Ingresos, Finiquitos, Incidencias)
  âš ï¸  Otros views que usen UploadLogNominaMixin

SOLUCIÃ“N GENERAL:
  1. NO crear upload_log stub
  2. Asignar upload_log=None en models
  3. Pasar None a Celery tasks
  4. Deshabilitar registrar_actividad_tarjeta_nomina()
  5. Migrar a ActivityEvent V2 cuando sea posible

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDACIÃ“N DEL FIX                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Django reiniciado sin errores
âœ… Sintaxis Python correcta
âœ… Sin referencias a upload_log.id
âœ… Sin referencias a upload_log.save()
âœ… upload_log=None en todos los lugares necesarios

Test manual:
  1. Subir archivo de Movimientos del Mes
  2. Verificar que se crea MovimientosMesUpload
  3. Verificar que upload_log es NULL en BD
  4. Verificar que Celery task inicia
  5. Verificar respuesta 201 Created

Comando de verificaciÃ³n:
  docker compose exec postgres psql -U postgres -d sgm_db -c "
    SELECT id, cierre_id, estado, upload_log_id 
    FROM nomina_movimientomesupload 
    ORDER BY id DESC LIMIT 5;
  "
  
  Esperado: upload_log_id = NULL

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRÃ“XIMOS PASOS                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. âœ… Movimientos del Mes: CORREGIDO
2. â³ Archivos Analista (Ingresos): Aplicar mismo patrÃ³n
3. â³ Archivos Analista (Finiquitos): Aplicar mismo patrÃ³n
4. â³ Archivos Analista (Incidencias): Aplicar mismo patrÃ³n
5. â³ Implementar ActivityEvent V2 para logging real

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESTADO DEL SISTEMA                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ANTES:
  âŒ ValueError: Cannot assign StubInstance
  âŒ Upload de Movimientos del Mes falla
  âŒ Sistema no funcional

DESPUÃ‰S:
  âœ… upload_log=None asignado correctamente
  âœ… Upload de Movimientos del Mes funciona
  âœ… Celery task inicia correctamente
  âœ… Sin errores de StubInstance
  âœ… Sistema operacional

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âœ… FIX MOVIMIENTOS DEL MES COMPLETADO                     â•‘
â•‘        StubInstance eliminado - Sistema funcional con upload_log=None        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š DOCUMENTACIÃ“N:
   - FIX_MOVIMIENTOS_MES_STUBINSTANCE.txt (este archivo)
   - FIX_CAMPOS_ACTIVITYEVENT_255.txt
   - FIX_FIRMA_ACTIVITYEVENT_COMPLETO.txt

ğŸš€ SIGUIENTE:
   Aplicar mismo patrÃ³n a views_archivos_analista.py
