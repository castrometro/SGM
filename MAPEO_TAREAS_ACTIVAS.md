# üó∫Ô∏è Mapeo de Tareas ACTIVAS en SGM

**Fecha Creaci√≥n**: 17 de octubre de 2025  
**√öltima Actualizaci√≥n**: 18 de octubre de 2025  
**Objetivo**: Identificar qu√© tareas de `tasks.py` se usan REALMENTE en las views  
**Estrategia**: Extraer SOLO las activas, mantener `tasks.py` original intacto

**Estado Refactorizaci√≥n**: 2 de 8 m√≥dulos completados (25%) ‚úÖ

---

## üìä Metodolog√≠a de Mapeo

```bash
# Buscar llamadas .delay() y .apply_async() en todas las views
grep -rn "\.delay\|\.apply_async" backend/nomina/views*.py

# Buscar imports de tasks
grep -rn "from .tasks import" backend/nomina/views*.py
```

**Total encontrado**: 34 llamadas a tareas Celery

---

## ‚úÖ Tareas ACTIVAS (Usadas en Views)

### **1. Libro de Remuneraciones** (10 tareas) ‚úÖ REFACTORIZADO

**Estado**: ‚úÖ COMPLETADO - Extra√≠do a `tasks_refactored/libro_remuneraciones.py`  
**Fecha Extracci√≥n**: 17-18 de octubre de 2025  
**Archivo**: `views_libro_remuneraciones.py`

```python
# ANTES (tasks.py original)
from .tasks import (
    analizar_headers_libro_remuneraciones_con_logging,
    clasificar_headers_libro_remuneraciones_con_logging,
    # ...
)

# AHORA (tasks_refactored)
from .tasks_refactored.libro_remuneraciones import (
    analizar_headers_libro_remuneraciones_con_logging,      # ‚úÖ REFACTORIZADA
    clasificar_headers_libro_remuneraciones_con_logging,    # ‚úÖ REFACTORIZADA
    actualizar_empleados_desde_libro,                       # ‚úÖ REFACTORIZADA
    guardar_registros_nomina,                               # ‚úÖ REFACTORIZADA
    actualizar_empleados_desde_libro_optimizado,            # ‚úÖ REFACTORIZADA (chord)
    guardar_registros_nomina_optimizado,                    # ‚úÖ REFACTORIZADA (chord)
    # + 4 helper tasks (procesar_chunk_*, consolidar_*)
)
```

**Mejoras implementadas**:
- ‚úÖ Logging dual (TarjetaActivityLogNomina + ActivityEvent)
- ‚úÖ Usuario correcto propagado (no m√°s Pablo Castro ID 1)
- ‚úÖ Estado "procesado" (no "completado") para consistencia con frontend
- ‚úÖ 807 l√≠neas en archivo dedicado

**Flujo**:
```
Upload Libro
    ‚Üì
analizar_headers_libro_remuneraciones_con_logging (usuario_id)
    ‚Üì
clasificar_headers_libro_remuneraciones_con_logging (usuario_id)
    ‚Üì (chord)
actualizar_empleados_desde_libro_optimizado (usuario_id)
    ‚Üì
guardar_registros_nomina_optimizado (usuario_id)
```

---

### **2. Movimientos del Mes** (1 tarea) ‚úÖ REFACTORIZADO

**Estado**: ‚úÖ COMPLETADO - Extra√≠do a `tasks_refactored/movimientos_mes.py`  
**Fecha Extracci√≥n**: 18 de octubre de 2025  
**Archivo**: `views_movimientos_mes.py`

```python
# ANTES (tasks.py original)
from .tasks import procesar_movimientos_mes

# AHORA (tasks_refactored)
from .tasks_refactored.movimientos_mes import procesar_movimientos_mes_con_logging

# Llamada simplificada (2 par√°metros vs 3):
# ANTES: procesar_movimientos_mes.delay(instance.id, None, request.user.id)
# AHORA: procesar_movimientos_mes_con_logging.delay(instance.id, request.user.id)
```

**Mejoras implementadas**:
- ‚úÖ Logging dual completo (TarjetaActivityLogNomina + ActivityEvent)
- ‚úÖ Usuario correcto propagado (verificado con Cecilia Reyes ID 24)
- ‚úÖ Estado "procesado" para consistencia con frontend
- ‚úÖ Eliminado par√°metro obsoleto `upload_log_id`
- ‚úÖ 309 l√≠neas en archivo dedicado
- ‚úÖ **VALIDADO EN PRODUCCI√ìN**: Procesamiento real ejecutado exitosamente

**Evidencia de Ejecuci√≥n Real**:
```
[INFO] Usuario: cecilia.reyes@bdo.cl (ID: 24)
[INFO] Resultados: {'ausentismos': 1, 'vacaciones': 1, 'variaciones_contrato': 2}
[INFO] ‚úÖ Estado: procesado (0.158s)
```

---

### **3. Archivos Analista** (1 tarea)

**Archivo**: `views_archivos_analista.py`

```python
from .tasks import procesar_archivo_analista  # ‚úÖ ACTIVA

# Llamadas (3 lugares):
procesar_archivo_analista.delay(archivo_analista.id)      # l√≠nea 102
procesar_archivo_analista.delay(archivo.id)               # l√≠nea 123
procesar_archivo_analista.delay(archivo_id, upload_log.id) # l√≠nea 255
```

---

### **4. Novedades** (1 tarea principal + workflow)

**Archivo**: `views_archivos_novedades.py`, `views.py`

```python
from .tasks import procesar_archivo_novedades  # ‚úÖ ACTIVA

# Llamadas directas:
procesar_archivo_novedades.delay(archivo_novedades.id)    # views_archivos_novedades.py:162
procesar_archivo_novedades.delay(archivo.id)              # views_archivos_novedades.py:189
procesar_archivo_novedades.delay(archivo_id, upload_log.id) # views_upload_con_logging.py:341

# Workflow complejo (views_archivos_novedades.py):
workflow = chain(
    analizar_headers_archivo_novedades.si(...),
    clasificar_headers_archivo_novedades_task.si(...),
    chord(
        [procesar_chunk_empleados_novedades_task.si(...) for chunk in chunks],
        procesar_chunk_registros_novedades_task.si(...)
    ),
    finalizar_procesamiento_novedades_task.si(...)
).apply_async()
```

**Tareas del workflow**:
- `analizar_headers_archivo_novedades` ‚úÖ
- `clasificar_headers_archivo_novedades_task` ‚úÖ
- `procesar_chunk_empleados_novedades_task` ‚úÖ
- `procesar_chunk_registros_novedades_task` ‚úÖ
- `finalizar_procesamiento_novedades_task` ‚úÖ

---

### **5. Consolidaci√≥n** (1 tarea)

**Archivo**: `views.py:314`

```python
from .tasks import consolidar_datos_nomina_task  # ‚úÖ ACTIVA

# Llamada:
task = consolidar_datos_nomina_task.delay(cierre.id, modo=modo_consolidacion)
```

**Nota**: Recibe par√°metro `modo` ‚Üí puede ser 'optimizado', 'secuencial', 'paralelo'

---

### **6. Incidencias** (3 tareas)

**Archivo**: `views.py`

```python
from .tasks import (
    generar_incidencias_consolidados_v2,      # ‚úÖ ACTIVA
    generar_incidencias_totales_simple,       # ‚úÖ ACTIVA
    generar_incidencias_cierre_task,          # ‚úÖ ACTIVA
)

# Llamadas:
generar_incidencias_consolidados_v2.delay(cierre.id, clasificaciones)  # l√≠nea 571
generar_incidencias_totales_simple.delay(cierre.id)                    # l√≠nea 2186
generar_incidencias_cierre_task.delay(pk)                              # l√≠nea 3267
```

---

### **7. Discrepancias** (2 tareas)

**Archivo**: `views.py`

```python
from .tasks import (
    analizar_datos_cierre_task,              # ‚úÖ ACTIVA
    generar_discrepancias_cierre_paralelo,   # ‚úÖ ACTIVA
    generar_discrepancias_cierre_task,       # ‚úÖ ACTIVA
)

# Llamadas:
analizar_datos_cierre_task.delay(cierre_id, tolerancia_variacion)     # l√≠nea 2612
generar_discrepancias_cierre_paralelo.delay(cierre_id, usuario_id)    # l√≠nea 3492
generar_discrepancias_cierre_task.delay(pk)                           # l√≠nea 3624
```

---

### **8. Informes** (3 tareas)

**Archivo**: `views_informes.py`

```python
from .tasks import (
    build_informe_libro,           # ‚úÖ ACTIVA
    build_informe_movimientos,     # ‚úÖ ACTIVA
    unir_y_guardar_informe,        # ‚úÖ ACTIVA
)

# Usado en workflows de generaci√≥n de informes
```

---

## üìã Resumen de Tareas ACTIVAS

| Dominio | Tareas Activas | Total |
|---------|----------------|-------|
| **Libro Remuneraciones** | analizar_headers_con_logging, clasificar_headers_con_logging, actualizar_empleados, guardar_registros, actualizar_empleados_optimizado, guardar_registros_optimizado | **6** |
| **Movimientos Mes** | procesar_movimientos_mes | **1** |
| **Archivos Analista** | procesar_archivo_analista | **1** |
| **Novedades** | procesar_archivo_novedades, analizar_headers, clasificar_headers, procesar_chunk_empleados, procesar_chunk_registros, finalizar_procesamiento | **6** |
| **Consolidaci√≥n** | consolidar_datos_nomina_task | **1** |
| **Incidencias** | generar_incidencias_consolidados_v2, generar_incidencias_totales_simple, generar_incidencias_cierre_task | **3** |
| **Discrepancias** | analizar_datos_cierre_task, generar_discrepancias_cierre_paralelo, generar_discrepancias_cierre_task | **3** |
| **Informes** | build_informe_libro, build_informe_movimientos, unir_y_guardar_informe | **3** |
| **TOTAL** | | **24** |

---

## üóëÔ∏è Tareas POTENCIALMENTE NO USADAS

En `tasks.py` hay **59 tareas**, pero solo **24 se usan activamente**.

**Candidatos a deprecated** (~35 tareas):

### **Versiones obsoletas de consolidaci√≥n**:
- `consolidar_datos_nomina_task_optimizado` (si `consolidar_datos_nomina_task` ya maneja el modo)
- `consolidar_datos_nomina_task_secuencial`
- `procesar_empleados_libro_paralelo` (standalone, no llamado)
- `procesar_movimientos_personal_paralelo`
- `procesar_conceptos_consolidados_paralelo`
- `finalizar_consolidacion_post_movimientos`
- `consolidar_resultados_finales`

### **Versiones sin logging** (duplicadas):
- `analizar_headers_libro_remuneraciones` (sin `_con_logging`)
- `clasificar_headers_libro_remuneraciones_task` (sin `_con_logging`)

### **Versiones de incidencias sin usar**:
- `procesar_chunk_comparacion_individual_task`
- `procesar_comparacion_suma_total_task`
- `consolidar_resultados_incidencias_task`
- `generar_incidencias_cierre_paralelo`
- `obtener_resultado_procesamiento_dual`
- `procesar_chunk_clasificaciones`
- `consolidar_resultados_filtrados`
- `consolidar_resultados_completos`
- `procesar_resultado_vacio`
- `comparar_y_generar_reporte_final`

### **Helpers que podr√≠an ser funciones privadas**:
- `obtener_clasificaciones_cierre`
- `crear_chunks`
- `procesar_incidencias_clasificacion_individual`
- `consolidar_resultados_chunks`
- `calcular_diferencias_resultados`
- `guardar_comparacion_incidencias`
- `actualizar_estado_cierre_post_procesamiento`

---

## üì¶ Plan de Extracci√≥n CONSERVADOR

### **Estrategia**:

1. **NO tocar `tasks.py` original** ‚úÖ
2. **Crear `nomina/tasks/` paralelo** con SOLO las 24 activas
3. **Mantener imports compatibles** en `__init__.py`
4. **Actualizar views gradualmente** (opcional)

### **Estructura Nueva**:

```
backend/nomina/
‚îú‚îÄ‚îÄ tasks.py                           # ‚ö†Ô∏è MANTENER INTACTO (legacy)
‚îÇ
‚îî‚îÄ‚îÄ tasks/                             # üÜï NUEVO PAQUETE
    ‚îú‚îÄ‚îÄ __init__.py                    # Exporta las 24 activas
    ‚îÇ
    ‚îú‚îÄ‚îÄ libro_remuneraciones.py        # 6 tareas
    ‚îÇ   ‚îú‚îÄ‚îÄ analizar_headers_con_logging
    ‚îÇ   ‚îú‚îÄ‚îÄ clasificar_headers_con_logging
    ‚îÇ   ‚îú‚îÄ‚îÄ actualizar_empleados
    ‚îÇ   ‚îú‚îÄ‚îÄ guardar_registros
    ‚îÇ   ‚îú‚îÄ‚îÄ actualizar_empleados_optimizado
    ‚îÇ   ‚îî‚îÄ‚îÄ guardar_registros_optimizado
    ‚îÇ
    ‚îú‚îÄ‚îÄ movimientos_mes.py             # 1 tarea
    ‚îÇ   ‚îî‚îÄ‚îÄ procesar_movimientos_mes
    ‚îÇ
    ‚îú‚îÄ‚îÄ archivos_analista.py           # 1 tarea
    ‚îÇ   ‚îî‚îÄ‚îÄ procesar_archivo_analista
    ‚îÇ
    ‚îú‚îÄ‚îÄ novedades.py                   # 6 tareas
    ‚îÇ   ‚îú‚îÄ‚îÄ procesar_archivo_novedades
    ‚îÇ   ‚îú‚îÄ‚îÄ analizar_headers
    ‚îÇ   ‚îú‚îÄ‚îÄ clasificar_headers_task
    ‚îÇ   ‚îú‚îÄ‚îÄ procesar_chunk_empleados_task
    ‚îÇ   ‚îú‚îÄ‚îÄ procesar_chunk_registros_task
    ‚îÇ   ‚îî‚îÄ‚îÄ finalizar_procesamiento_task
    ‚îÇ
    ‚îú‚îÄ‚îÄ consolidacion.py               # 1 tarea
    ‚îÇ   ‚îî‚îÄ‚îÄ consolidar_datos_nomina_task
    ‚îÇ
    ‚îú‚îÄ‚îÄ incidencias.py                 # 3 tareas
    ‚îÇ   ‚îú‚îÄ‚îÄ generar_incidencias_consolidados_v2
    ‚îÇ   ‚îú‚îÄ‚îÄ generar_incidencias_totales_simple
    ‚îÇ   ‚îî‚îÄ‚îÄ generar_incidencias_cierre_task
    ‚îÇ
    ‚îú‚îÄ‚îÄ discrepancias.py               # 3 tareas
    ‚îÇ   ‚îú‚îÄ‚îÄ analizar_datos_cierre_task
    ‚îÇ   ‚îú‚îÄ‚îÄ generar_discrepancias_cierre_paralelo
    ‚îÇ   ‚îî‚îÄ‚îÄ generar_discrepancias_cierre_task
    ‚îÇ
    ‚îî‚îÄ‚îÄ informes.py                    # 3 tareas
        ‚îú‚îÄ‚îÄ build_informe_libro
        ‚îú‚îÄ‚îÄ build_informe_movimientos
        ‚îî‚îÄ‚îÄ unir_y_guardar_informe
```

### **`tasks/__init__.py`** (Retrocompatibilidad):

```python
# backend/nomina/tasks/__init__.py

"""
üîÑ Tareas Celery Refactorizadas - Solo tareas ACTIVAS

Este paquete contiene las 24 tareas que se usan activamente en las views.
El archivo tasks.py original se mantiene intacto como fallback.
"""

# Libro de Remuneraciones (6)
from .libro_remuneraciones import (
    analizar_headers_libro_remuneraciones_con_logging,
    clasificar_headers_libro_remuneraciones_con_logging,
    actualizar_empleados_desde_libro,
    guardar_registros_nomina,
    actualizar_empleados_desde_libro_optimizado,
    guardar_registros_nomina_optimizado,
)

# Movimientos del Mes (1)
from .movimientos_mes import (
    procesar_movimientos_mes,
)

# Archivos Analista (1)
from .archivos_analista import (
    procesar_archivo_analista,
)

# Novedades (6)
from .novedades import (
    procesar_archivo_novedades,
    analizar_headers_archivo_novedades,
    clasificar_headers_archivo_novedades_task,
    procesar_chunk_empleados_novedades_task,
    procesar_chunk_registros_novedades_task,
    finalizar_procesamiento_novedades_task,
)

# Consolidaci√≥n (1)
from .consolidacion import (
    consolidar_datos_nomina_task,
)

# Incidencias (3)
from .incidencias import (
    generar_incidencias_consolidados_v2,
    generar_incidencias_totales_simple,
    generar_incidencias_cierre_task,
)

# Discrepancias (3)
from .discrepancias import (
    analizar_datos_cierre_task,
    generar_discrepancias_cierre_paralelo,
    generar_discrepancias_cierre_task,
)

# Informes (3)
from .informes import (
    build_informe_libro,
    build_informe_movimientos,
    unir_y_guardar_informe,
)

__all__ = [
    # Libro (6)
    'analizar_headers_libro_remuneraciones_con_logging',
    'clasificar_headers_libro_remuneraciones_con_logging',
    'actualizar_empleados_desde_libro',
    'guardar_registros_nomina',
    'actualizar_empleados_desde_libro_optimizado',
    'guardar_registros_nomina_optimizado',
    # Movimientos (1)
    'procesar_movimientos_mes',
    # Analista (1)
    'procesar_archivo_analista',
    # Novedades (6)
    'procesar_archivo_novedades',
    'analizar_headers_archivo_novedades',
    'clasificar_headers_archivo_novedades_task',
    'procesar_chunk_empleados_novedades_task',
    'procesar_chunk_registros_novedades_task',
    'finalizar_procesamiento_novedades_task',
    # Consolidaci√≥n (1)
    'consolidar_datos_nomina_task',
    # Incidencias (3)
    'generar_incidencias_consolidados_v2',
    'generar_incidencias_totales_simple',
    'generar_incidencias_cierre_task',
    # Discrepancias (3)
    'analizar_datos_cierre_task',
    'generar_discrepancias_cierre_paralelo',
    'generar_discrepancias_cierre_task',
    # Informes (3)
    'build_informe_libro',
    'build_informe_movimientos',
    'unir_y_guardar_informe',
]
```

---

## ‚úÖ Ventajas de Este Enfoque

1. **Seguro**: `tasks.py` original intacto como fallback
2. **Limpio**: Solo 24 tareas activas, bien organizadas
3. **Compatible**: Views siguen funcionando (`from .tasks import X`)
4. **Gradual**: Podemos migrar views poco a poco
5. **Documentado**: Sabemos exactamente qu√© se usa

---

## üöÄ Pr√≥ximos Pasos

### **Fase 1: Crear estructura** (30 min)
```bash
mkdir backend/nomina/tasks
touch backend/nomina/tasks/__init__.py
```

### **Fase 2: Extraer Libro (PRIMERO)** (2h)
- Copiar 6 tareas a `tasks/libro_remuneraciones.py`
- Limpiar c√≥digo, agregar ActivityEvent integrado
- Test: Subir libro ‚Üí Verificar funciona

### **Fase 3: Extraer resto** (4h)
- Consolidaci√≥n (1 tarea)
- Movimientos (1 tarea)
- Novedades (6 tareas)
- Incidencias (3 tareas)
- Discrepancias (3 tareas)
- Informes (3 tareas)
- Analista (1 tarea)

### **Fase 4: Validaci√≥n** (1h)
- Verificar Celery registra las 24 tareas
- Test end-to-end de cada flujo
- Logs limpios sin errores

---

## üìä Comparaci√≥n Final

| M√©trica | ANTES | DESPU√âS |
|---------|-------|---------|
| Archivo principal | 5,279 l√≠neas | ~50 l√≠neas (mantener como est√°) |
| Tareas expuestas | 59 tareas mezcladas | 24 tareas activas organizadas |
| Archivos | 1 monolito | 8 m√≥dulos especializados |
| C√≥digo muerto | ~35 tareas sin usar | 0 (no extra√≠do) |
| Mantenibilidad | ‚ùå Imposible | ‚úÖ Alta |

---

**Estado**: Mapeo completo ‚úÖ  
**Pr√≥ximo**: Crear estructura y extraer Libro de Remuneraciones  
**Tiempo estimado**: 8 horas total
